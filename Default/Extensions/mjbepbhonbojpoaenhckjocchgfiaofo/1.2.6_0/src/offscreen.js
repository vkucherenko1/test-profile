(()=>{"use strict";var e={70864:function(e){var t=Object.prototype.hasOwnProperty,r="~";function s(){}function n(e,t,r){this.fn=e,this.context=t,this.once=r||!1}function o(e,t,s,o,i){if("function"!=typeof s)throw TypeError("The listener must be a function");var a=new n(s,o||e,i),c=r?r+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],a]:e._events[c].push(a):(e._events[c]=a,e._eventsCount++),e}function i(e,t){0==--e._eventsCount?e._events=new s:delete e._events[t]}function a(){this._events=new s,this._eventsCount=0}Object.create&&(s.prototype=Object.create(null),new s().__proto__||(r=!1)),a.prototype.eventNames=function(){var e,s,n=[];if(0===this._eventsCount)return n;for(s in e=this._events)t.call(e,s)&&n.push(r?s.slice(1):s);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(e)):n},a.prototype.listeners=function(e){var t=r?r+e:e,s=this._events[t];if(!s)return[];if(s.fn)return[s.fn];for(var n=0,o=s.length,i=Array(o);n<o;n++)i[n]=s[n].fn;return i},a.prototype.listenerCount=function(e){var t=r?r+e:e,s=this._events[t];return s?s.fn?1:s.length:0},a.prototype.emit=function(e,t,s,n,o,i){var a=r?r+e:e;if(!this._events[a])return!1;var c,l,h=this._events[a],d=arguments.length;if(h.fn){switch(h.once&&this.removeListener(e,h.fn,void 0,!0),d){case 1:return h.fn.call(h.context),!0;case 2:return h.fn.call(h.context,t),!0;case 3:return h.fn.call(h.context,t,s),!0;case 4:return h.fn.call(h.context,t,s,n),!0;case 5:return h.fn.call(h.context,t,s,n,o),!0;case 6:return h.fn.call(h.context,t,s,n,o,i),!0}for(l=1,c=Array(d-1);l<d;l++)c[l-1]=arguments[l];h.fn.apply(h.context,c)}else{var u,g=h.length;for(l=0;l<g;l++)switch(h[l].once&&this.removeListener(e,h[l].fn,void 0,!0),d){case 1:h[l].fn.call(h[l].context);break;case 2:h[l].fn.call(h[l].context,t);break;case 3:h[l].fn.call(h[l].context,t,s);break;case 4:h[l].fn.call(h[l].context,t,s,n);break;default:if(!c)for(u=1,c=Array(d-1);u<d;u++)c[u-1]=arguments[u];h[l].fn.apply(h[l].context,c)}}return!0},a.prototype.on=function(e,t,r){return o(this,e,t,r,!1)},a.prototype.once=function(e,t,r){return o(this,e,t,r,!0)},a.prototype.removeListener=function(e,t,s,n){var o=r?r+e:e;if(!this._events[o])return this;if(!t)return i(this,o),this;var a=this._events[o];if(a.fn)a.fn!==t||n&&!a.once||s&&a.context!==s||i(this,o);else{for(var c=0,l=[],h=a.length;c<h;c++)(a[c].fn!==t||n&&!a[c].once||s&&a[c].context!==s)&&l.push(a[c]);l.length?this._events[o]=1===l.length?l[0]:l:i(this,o)}return this},a.prototype.removeAllListeners=function(e){var t;return e?(t=r?r+e:e,this._events[t]&&i(this,t)):(this._events=new s,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=r,a.EventEmitter=a,e.exports=a}},t={};function r(s){var n=t[s];if(void 0!==n)return n.exports;var o=t[s]={exports:{}};return e[s](o,o.exports,r),o.exports}r.rv=()=>"1.4.11",r.ruid="bundler=rspack@1.4.11",(()=>{let e,t=/YYYY|MM|DD|HH|mm|ss/g;function s(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}let n={none:0,trace:10,debug:100,info:1e3,warn:1e4,error:1e5};class o{log(e,r){let s;for(var o=arguments.length,i=Array(o>2?o-2:0),a=2;a<o;a++)i[a-2]=arguments[a];let c=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];let s={};return t.forEach(e=>{e.forEach(e=>{Object.keys(e).forEach(t=>{s[t]=e[t]})})}),s}(this.label,i);n[e]>=n[this.core.level]&&this.core.writer.write(e,r,c);try{s=JSON.stringify(c)}catch(e){s=c,console.error("Logger label JSON stringify error:",e)}if("none"!==this.core.consoleLevel&&n[e]>=n[this.core.consoleLevel]){"object"==typeof r&&(r=JSON.stringify(r));let n=`${function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Date,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"YYYY-MM-DD HH:mm:ss";return r.replace(t,t=>{switch(t){case"YYYY":return e.getFullYear().toString();case"MM":{let t=e.getMonth()+1;return t<10?"0"+t:t.toString()}case"DD":{let t=e.getDate();return t<10?"0"+t:t.toString()}case"HH":{let t=e.getHours();return t<10?"0"+t:t.toString()}case"mm":{let t=e.getMinutes();return t<10?"0"+t:t.toString()}case"ss":{let t=e.getSeconds();return t<10?"0"+t:t.toString()}}return t})}(new Date,"YYYY-MM-DD HH:mm:ss")} [${e}] ${r}`;switch(e){case"error":console.error(n,s);break;case"warn":console.warn(n,s);break;default:console.info(n,s)}}}with(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new o(this.core,...this.label,...t)}trace(e){for(var t=arguments.length,r=Array(t>1?t-1:0),s=1;s<t;s++)r[s-1]=arguments[s];this.log("trace",e,...r)}debug(e){for(var t=arguments.length,r=Array(t>1?t-1:0),s=1;s<t;s++)r[s-1]=arguments[s];this.log("debug",e,...r)}info(e){for(var t=arguments.length,r=Array(t>1?t-1:0),s=1;s<t;s++)r[s-1]=arguments[s];this.log("info",e,...r)}warn(e){for(var t=arguments.length,r=Array(t>1?t-1:0),s=1;s<t;s++)r[s-1]=arguments[s];this.log("warn",e,...r)}error(e){for(var t=arguments.length,r=Array(t>1?t-1:0),s=1;s<t;s++)r[s-1]=arguments[s];this.log("error",e,...r)}static E(e){return"string"==typeof e?{error:e}:e instanceof Error?{error:e.message}:"object"==typeof e?e:{}}constructor(e,...t){s(this,"core",void 0),s(this,"label",void 0),this.core=e,this.label=t}}function i(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class a{static getInstance(){return a.instance}static logger(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return a.getInstance().logger(...t)}logger(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new o(this,this.labels,...t)}constructor(e){i(this,"writer",void 0),i(this,"level","info"),i(this,"consoleLevel","warn"),i(this,"labels",void 0),this.writer=e.writer,this.level=e.level||this.level,this.labels=e.labels||{},void 0!==e.consoleLevel&&(this.consoleLevel=e.consoleLevel),a.instance||(a.instance=this)}}function c(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}i(a,"instance",void 0);class l{write(e,t,r){this.send.sendMessage({action:this.action,data:{id:0,level:e,message:t,label:r,createtime:Date.now()}})}constructor(e,t="logger"){c(this,"action",void 0),c(this,"send",void 0),this.action=t,this.send=e}}function h(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}async function d(e,t,r){let s=await e.sendMessage({action:t,data:r}),n=a.getInstance().logger().with({action:t,data:r,response:s});if(n.trace("sendMessage"),null==s?void 0:s.code)throw console.error(s),s.message;try{return s.data}catch(e){n.trace("Invalid response data",o.E(e));return}}class u{do(e,t){return d(this.msg,`${this.prefix}${e}`,t)}async doThrow(e,t){let r=await d(this.msg,`${this.prefix}${e}`,t);if(!r)throw Error(`doThrow: ${this.prefix}${e}`);return r}constructor(e,t){h(this,"msg",void 0),h(this,"prefix",void 0),this.msg=e,this.prefix=t,this.prefix&&!this.prefix.endsWith("/")?this.prefix+="/":this.prefix=""}}class g{connect(e){return new Promise(t=>{let r=chrome.runtime.connect();r.postMessage(e),t(new p(r))})}sendMessage(e){return new Promise(t=>{chrome.runtime.sendMessage(e,e=>{let r=chrome.runtime.lastError;if(r){console.error("chrome.runtime.lastError in chrome.runtime.sendMessage:",r),t=null;return}t(e),t=null})})}constructor(){}}class p{sendMessage(e){this.con.postMessage(e)}onMessage(e){this.con.onMessage.addListener(e)}disconnect(){this.con.disconnect()}onDisconnect(e){this.con.onDisconnect.addListener(e)}getPort(){return this.con}constructor(e){!function(e,t,r){"con"in e?Object.defineProperty(e,"con",{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(this,"con",void 0),this.con=e}}function f(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class m{getSender(){return this.sender instanceof p?this.sender.getPort().sender:this.sender}getExtMessageSender(){var e,t,r,s,n,o,i,a;if(this.sender instanceof p){let e=this.sender.getPort();return{windowId:(null==(s=e.sender)||null==(r=s.tab)?void 0:r.windowId)||-1,tabId:(null==(o=e.sender)||null==(n=o.tab)?void 0:n.id)||-1,frameId:null==(i=e.sender)?void 0:i.frameId,documentId:null==(a=e.sender)?void 0:a.documentId}}let c=this.sender;return{windowId:(null==(e=c.tab)?void 0:e.windowId)||-1,tabId:(null==(t=c.tab)?void 0:t.id)||-1,frameId:c.frameId,documentId:c.documentId}}getConnect(){return this.sender}constructor(e){f(this,"sender",void 0),this.sender=e}}class v{group(e){return new w(this,e)}on(e,t){this.apiFunctionMap.set(e,t)}connectHandle(e,t,r){let s=this.apiFunctionMap.get(e);if(s){let e=s(t,new m(r));return e&&(e instanceof Promise?e.then(e=>{e&&r.sendMessage({code:0,data:e})}).catch(e=>{r.sendMessage({code:-1,message:e.message||e.toString()})}):r.sendMessage({code:0,data:e})),!0}}messageHandle(e,t,r,s){let n=this.apiFunctionMap.get(e);if(n)try{let e=n(t,new m(s));if(e instanceof Promise)return e.then(e=>{try{r({code:0,data:e})}catch(e){this.logger.error("sendResponse error",o.E(e))}}).catch(e=>{r({code:-1,message:e.message||e.toString()})}),!0;r({code:0,data:e})}catch(e){r({code:-1,message:e.message||e.toString()})}else r({code:-1,message:"no such api "+e}),this.logger.error("no such api",{action:e})}constructor(e,t,r=!0){f(this,"enableConnect",void 0),f(this,"apiFunctionMap",void 0),f(this,"logger",void 0),this.enableConnect=r,this.apiFunctionMap=new Map,this.logger=a.getInstance().logger({service:"messageServer"}),this.enableConnect&&t.onConnect((t,r)=>{var s;if("string"==typeof t.action)return this.logger.trace("server onConnect",{msg:t}),null!=(s=t.action)&&!!s.startsWith(e)&&this.connectHandle(t.action.slice(e.length+1),t.data,r)}),t.onMessage((t,r,s)=>{var n;if("string"==typeof t.action)return this.logger.trace("server onMessage",{msg:t}),null!=(n=t.action)&&!!n.startsWith(e)&&this.messageHandle(t.action.slice(e.length+1),t.data,r,s)})}}class w{group(e){return new w(this.server,`${this.name}${e}`)}on(e,t){this.server.on(`${this.name}${e}`,t)}constructor(e,t){f(this,"server",void 0),f(this,"name",void 0),this.server=e,this.name=t,t.endsWith("/")||(this.name+="/")}}function b(e,t,r,s,n){let o=(r,n)=>{var o;let i=n.getConnect();if(!i)return d(s,e+"/"+t,r);(o=`${e}/${t}`,s.connect({action:o,data:r})).then(e=>{i.onMessage(t=>{e.sendMessage(t)}),e.onMessage(e=>{i.sendMessage(e)}),i.onDisconnect(()=>{e.disconnect()}),e.onDisconnect(()=>{i.disconnect()})})};r.on(t,(e,t)=>{if(n){let r=n(e,t);if(r instanceof Promise)return r.then(r=>!1!==r?r:o(e,t));if(!1!==r)return r}return o(e,t)})}let y={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)},E=new Uint8Array(16),M=[];for(let e=0;e<256;++e)M.push((e+256).toString(16).slice(1));function x(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return(M[e[t+0]]+M[e[t+1]]+M[e[t+2]]+M[e[t+3]]+"-"+M[e[t+4]]+M[e[t+5]]+"-"+M[e[t+6]]+M[e[t+7]]+"-"+M[e[t+8]]+M[e[t+9]]+"-"+M[e[t+10]]+M[e[t+11]]+M[e[t+12]]+M[e[t+13]]+M[e[t+14]]+M[e[t+15]]).toLowerCase()}let S=function(t,r,s){var n;if(y.randomUUID&&!r&&!t)return y.randomUUID();let o=(t=t||{}).random??(null==(n=t.rng)?void 0:n.call(t))??function(){if(!e){if("undefined"==typeof crypto||!crypto.getRandomValues)throw Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");e=crypto.getRandomValues.bind(crypto)}return e(E)}();if(o.length<16)throw Error("Random bytes length must be >= 16");if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,r){if((s=s||0)<0||s+16>r.length)throw RangeError(`UUID byte range ${s}:${s+15} is out of buffer bounds`);for(let e=0;e<16;++e)r[s+e]=o[e];return r}return x(o)};class C{get(e){return new Promise(t=>{chrome.storage.session.get(e,r=>{let s=chrome.runtime.lastError;s&&console.error("chrome.runtime.lastError in chrome.storage.session.get:",s),t(r[e])})})}set(e,t){return new Promise(r=>{chrome.storage.session.set({[e]:t},()=>{let e=chrome.runtime.lastError;e&&console.error("chrome.runtime.lastError in chrome.storage.session.set:",e),r()})})}batchSet(e){return new Promise(t=>{chrome.storage.session.set(e,()=>{let e=chrome.runtime.lastError;e&&console.error("chrome.runtime.lastError in chrome.storage.session.set:",e),t()})})}has(e){return new Promise(t=>{chrome.storage.session.get(e,r=>{let s=chrome.runtime.lastError;s&&console.error("chrome.runtime.lastError in chrome.storage.session.get:",s),t(void 0!==r[e])})})}del(e){return new Promise(t=>{chrome.storage.session.remove(e,()=>{let e=chrome.runtime.lastError;e&&console.error("chrome.runtime.lastError in chrome.storage.session.remove:",e),t()})})}clear(){return new Promise(e=>{chrome.storage.session.clear(()=>{let t=chrome.runtime.lastError;t&&console.error("chrome.runtime.lastError in chrome.storage.session.clear:",t),e()})})}list(){return new Promise(e=>{chrome.storage.session.get(null,t=>{let r=chrome.runtime.lastError;r&&console.error("chrome.runtime.lastError in chrome.storage.session.get:",r),e(Object.keys(t))})})}}new class extends C{async getOrSet(e,t){let r=await this.get(e);return r||(r=await t(),this.set(e,r)),r}lock(e){let t=this.txLock.has(e),r=()=>{var t;let s=null==(t=this.txLock.get(e))?void 0:t.shift();s?s(r):this.txLock.delete(e)};if(t){let t=this.txLock.get(e);return t||(t=[],this.txLock.set(e,t)),new Promise(e=>{t.push(e)})}return this.txLock.set(e,[]),r}async tx(e,t){let r,s=await this.lock(e);return await this.get(e).then(e=>t(e)).then(t=>t?(r=t,this.set(e,t)):void 0===t?this.del(e):void 0),s(),r}incr(e,t){return this.tx(e,e=>(e||0)+t)}constructor(...e){super(...e),function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(this,"txLock",new Map)}};class I extends u{preparationOffscreen(){return this.do("preparationOffscreen")}constructor(e){super(e,"serviceWorker")}}class R extends u{getAllScripts(){return this.doThrow("getAllScripts")}getInstallInfo(e){return this.do("getInstallInfo",e)}install(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"user";return this.doThrow("install",{script:e,code:t,upsertBy:r})}delete(e){return this.do("delete",e)}enable(e,t){return this.do("enable",{uuid:e,enable:t})}info(e){return this.doThrow("fetchInfo",e)}getCode(e){return this.do("getCode",e)}getScriptRunResource(e){return this.doThrow("getScriptRunResource",e)}excludeUrl(e,t,r){return this.do("excludeUrl",{uuid:e,url:t,remove:r})}resetMatch(e,t){return this.do("resetMatch",{uuid:e,match:t})}resetExclude(e,t){return this.do("resetExclude",{uuid:e,exclude:t})}requestCheckUpdate(e){return this.do("requestCheckUpdate",e)}sortScript(e,t){return this.do("sortScript",{active:e,over:t})}importByUrl(e){return this.do("importByUrl",e)}installByCode(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"user";return this.do("installByCode",{uuid:e,code:t,upsertBy:r})}async formatUrl(e){try{let{hostname:t,pathname:r}=new URL(e.replace(/\/$/,""));if(!("scriptcat.org"===t&&/script-show-page\/\d+$/.test(r)))return e;{let e=r.match(/\d+$/)[0],{code:t,data:s,msg:n}=await fetch(`https://scriptcat.org/api/v2/scripts/${e}`).then(e=>e.json()).then(e=>e);if(0!==t)return{success:!1,msg:n};{let t=s.name;return`https://scriptcat.org/scripts/code/${e}/${t}.user.js`}}}catch{return e}}async importByUrls(e){if(0==e.length)return;let t=await Promise.allSettled(e.map(async e=>{let t=await this.formatUrl(e);return t instanceof Object?await Promise.resolve(t):await this.do("importByUrl",t)})),r={success:0,fail:0,msg:[]};return t.forEach((e,t)=>{let{value:s}=e;s.success?r.success++:(r.fail++,r.msg.push(`#${t+1}: ${s.msg}`))}),r}setCheckUpdateUrl(e,t,r){return this.do("setCheckUpdateUrl",{uuid:e,checkUpdate:t,checkUpdateUrl:r})}constructor(e){super(e,"serviceWorker/script")}}class L extends u{getScriptResources(e){return this.doThrow("getScriptResources",e)}deleteResource(e){return this.do("deleteResource",e)}constructor(e){super(e,"serviceWorker/resource")}}class U extends u{getScriptValue(e){return this.doThrow("getScriptValue",e)}setScriptValue(e,t,r){return this.do("setScriptValue",{uuid:e,key:t,value:r})}setScriptValues(e,t){return this.do("setScriptValues",{uuid:e,values:t})}constructor(e){super(e,"serviceWorker/value")}}function T(e,t){return d(e,"sandbox/enableScript",t)}function k(e,t){return d(e,"sandbox/disableScript",t)}function O(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class D{runScript(e){d(this.windowMessage,"sandbox/runScript",e)}stopScript(e){d(this.windowMessage,"sandbox/stopScript",e)}async init(){this.messageQueue.subscribe("enableScript",async e=>{let t=await this.scriptClient.info(e.uuid);1!==t.type&&(e.enable?T(this.windowMessage,await this.scriptClient.getScriptRunResource(t)):k(this.windowMessage,t.uuid))}),this.messageQueue.subscribe("installScript",async e=>{1!==e.script.type&&(1===e.script.status?T(this.windowMessage,await this.scriptClient.getScriptRunResource(e.script)):k(this.windowMessage,e.script.uuid))}),this.messageQueue.subscribe("deleteScript",async e=>{k(this.windowMessage,e.uuid)}),this.group.on("runScript",this.runScript.bind(this)),this.group.on("stopScript",this.stopScript.bind(this))}constructor(e,t,r,s){O(this,"group",void 0),O(this,"extensionMessage",void 0),O(this,"windowMessage",void 0),O(this,"messageQueue",void 0),O(this,"logger",void 0),O(this,"scriptClient",void 0),O(this,"resourceClient",void 0),O(this,"valueClient",void 0),this.group=e,this.extensionMessage=t,this.windowMessage=r,this.messageQueue=s,this.scriptClient=new R(this.extensionMessage),this.resourceClient=new L(this.extensionMessage),this.valueClient=new U(this.extensionMessage),this.logger=a.logger().with({service:"script"})}}var P=r(70864);function j(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class A{postMessage(e){this.target.postMessage(e,"*")}constructor(e){j(this,"target",void 0),this.target=e}}class ${messageHandle(e,t){"sendMessage"===e.type?this.EE.emit("message",e.data,r=>{if(!e.messageId)return;let s={messageId:e.messageId,type:"respMessage",data:r};t.postMessage(s)}):"respMessage"===e.type?this.EE.emit(`response:${e.messageId}`,e):"connect"===e.type?this.EE.emit("connect",e.data,new H(e.messageId,this.EE,t)):"disconnect"===e.type?this.EE.emit(`disconnect:${e.messageId}`):"connectMessage"===e.type&&this.EE.emit(`connectMessage:${e.messageId}`,e.data)}onConnect(e){this.EE.addListener("connect",e)}connect(e){return new Promise(t=>{let r={messageId:S(),type:"connect",data:e};this.target.postMessage(r,"*"),t(new H(r.messageId,this.EE,this.target))})}onMessage(e){this.EE.addListener("message",e)}sendMessage(e){return new Promise(t=>{let r={messageId:S(),type:"sendMessage",data:e},s=`response:${r.messageId}`,n=e=>{null!==n&&(this.EE.removeListener(s,n),t(e.data),n=null,t=null)};this.EE.addListener(s,n),this.target.postMessage(r,"*")})}constructor(e,t,r){j(this,"source",void 0),j(this,"target",void 0),j(this,"serviceWorker",void 0),j(this,"EE",void 0),this.source=e,this.target=t,this.serviceWorker=r,this.EE=new P,this.source.addEventListener("message",e=>{(e.source===this.target||e.source===this.source)&&this.messageHandle(e.data,new A(this.target))}),this.serviceWorker&&navigator.serviceWorker.addEventListener("message",e=>{e.source&&this.messageHandle(e.data,e.source)})}}class H{sendMessage(e){let t={messageId:this.messageId,type:"connectMessage",data:e};this.target.postMessage(t)}onMessage(e){this.EE.addListener(`connectMessage:${this.messageId}`,e)}disconnect(){let e={messageId:this.messageId,type:"disconnect",data:null};this.target.postMessage(e)}onDisconnect(e){this.EE.addListener(`disconnect:${this.messageId}`,e)}constructor(e,t,r){j(this,"messageId",void 0),j(this,"EE",void 0),j(this,"target",void 0),this.messageId=e,this.EE=t,this.target=r,this.onDisconnect(()=>{this.EE.removeAllListeners("connectMessage:"+this.messageId),this.EE.removeAllListeners("disconnect:"+this.messageId)})}}function _(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class W{async dealXhrResponse(e,t,r,s,n){let i={finalUrl:s.responseURL||t.url,readyState:s.readyState,status:s.status,statusText:s.statusText,responseHeaders:s.getAllResponseHeaders(),responseType:t.responseType};if(4===s.readyState){var c,l;let e=null==(c=t.responseType)?void 0:c.toLowerCase();if("arraybuffer"===e||"blob"===e){let e=s.response;if(null===e)i.response=null;else{let t;t=e instanceof ArrayBuffer?new Blob([e]):e,i.response=URL.createObjectURL(t);try{(null==(l=s.getResponseHeader("Content-Type"))?void 0:l.includes("text"))&&(i.responseText=await t.text())}catch(e){a.logger(o.E(e)).error("GM XHR getResponseHeader error")}setTimeout(()=>{URL.revokeObjectURL(i.response)},6e4)}}else if("json"===i.responseType){try{i.response=JSON.parse(s.responseText)}catch(e){a.logger(o.E(e)).error("GM XHR JSON parse error")}try{i.responseText=s.responseText}catch(e){a.logger(o.E(e)).error("GM XHR getResponseText error")}}else{try{i.response=s.response}catch(e){a.logger(o.E(e)).error("GM XHR response error")}try{i.responseText=s.responseText||void 0}catch(e){a.logger(o.E(e)).error("GM XHR getResponseText error")}}}return n&&(i=Object.assign(i,n)),e.sendMessage({action:r,data:i}),i}async xmlHttpRequest(e,t){if("stream"===e.responseType)throw Error("Method not implemented.");let r=new XMLHttpRequest,s=t.getConnect();if(r.open(e.method||"GET",e.url,!0,e.user||"",e.password||""),e.headers)for(let t in e.headers)r.setRequestHeader(t,e.headers[t]);if(e.timeout&&(r.timeout=e.timeout),e.overrideMimeType&&r.overrideMimeType(e.overrideMimeType),"json"!==e.responseType&&(r.responseType=e.responseType||""),r.onload=()=>{this.dealXhrResponse(s,e,"onload",r)},r.onloadstart=()=>{this.dealXhrResponse(s,e,"onloadstart",r)},r.onloadend=()=>{this.dealXhrResponse(s,e,"onloadend",r)},r.onabort=()=>{this.dealXhrResponse(s,e,"onabort",r)},r.onerror=()=>{this.dealXhrResponse(s,e,"onerror",r)},r.onprogress=t=>{let n={done:r.DONE,lengthComputable:t.lengthComputable,loaded:t.loaded,total:t.total,totalSize:t.total};this.dealXhrResponse(s,e,"onprogress",r,n)},r.onreadystatechange=()=>{this.dealXhrResponse(s,e,"onreadystatechange",r)},r.ontimeout=()=>{null==s||s.sendMessage({action:"ontimeout",data:{}})},"FormData"===e.dataType){let t=new FormData;e.data&&e.data instanceof Array&&(await Promise.all(e.data.map(async e=>{if("file"===e.type){let r=new File([await (await fetch(e.val)).blob()],e.filename);t.append(e.key,r,e.filename)}else t.append(e.key,e.val)})),r.send(t))}else if("Blob"===e.dataType){if(!e.data)throw Error("Blob data is empty");let t=await (await fetch(e.data)).blob();r.send(t)}else r.send(e.data);null==s||s.onDisconnect(()=>{r.abort()})}async openInTab(e){let{url:t}=e;return void 0!==window.open(t)}async setClipboard(e){let{data:t,type:r}=e;this.clipboardData={type:r,data:t},this.textarea.focus(),document.execCommand("copy",!1,null)}init(){this.textarea.style.display="none",document.documentElement.appendChild(this.textarea),document.addEventListener("copy",e=>{if(!this.clipboardData||!e.clipboardData)return;e.preventDefault();let{type:t,data:r}=this.clipboardData;e.clipboardData.setData(t||"text/plain",r),this.clipboardData=void 0}),this.group.on("xmlHttpRequest",this.xmlHttpRequest.bind(this)),this.group.on("openInTab",this.openInTab.bind(this)),this.group.on("setClipboard",this.setClipboard.bind(this))}constructor(e){_(this,"group",void 0),_(this,"logger",void 0),_(this,"textarea",void 0),_(this,"clipboardData",void 0),this.group=e,this.logger=a.logger().with({service:"gmApi"}),this.textarea=document.createElement("textarea")}}class V{handler(e,t){let{action:r,message:s}=t;if(a.getInstance().logger({service:"messageQueue"}).trace("messageQueueHandler",{action:r,topic:e,message:s}),"message"===r)this.EE.emit(e,s);else throw Error("action not found")}subscribe(e,t){return this.EE.on(e,t),()=>{this.EE.off(e,t)}}publish(e,t){chrome.runtime.sendMessage({msgQueue:e,data:{action:"message",message:t}}),this.EE.emit(e,t),a.getInstance().logger({service:"messageQueue"}).trace("publish",{topic:e,message:t})}emit(e,t){this.EE.emit(e,t)}constructor(){!function(e,t,r){"EE"in e?Object.defineProperty(e,"EE",{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(this,"EE",new P),chrome.runtime.onMessage.addListener(e=>{let t=chrome.runtime.lastError,r=e.msgQueue;if("string"==typeof r){if(t)return console.error("chrome.runtime.lastError in chrome.runtime.onMessage:",t),!1;this.handler(r,e.data)}})}}function Y(e,t){return e<<t|e>>>32-t}let X=function(e){let t=[0x5a827999,0x6ed9eba1,0x8f1bbcdc,0xca62c1d6],r=[0x67452301,0xefcdab89,0x98badcfe,0x10325476,0xc3d2e1f0],s=new Uint8Array(e.length+1);s.set(e),s[e.length]=128;let n=Math.ceil(((e=s).length/4+2)/16),o=Array(n);for(let t=0;t<n;++t){let r=new Uint32Array(16);for(let s=0;s<16;++s)r[s]=e[64*t+4*s]<<24|e[64*t+4*s+1]<<16|e[64*t+4*s+2]<<8|e[64*t+4*s+3];o[t]=r}o[n-1][14]=(e.length-1)*8/0x100000000,o[n-1][14]=Math.floor(o[n-1][14]),o[n-1][15]=(e.length-1)*8|0;for(let e=0;e<n;++e){let s=new Uint32Array(80);for(let t=0;t<16;++t)s[t]=o[e][t];for(let e=16;e<80;++e)s[e]=Y(s[e-3]^s[e-8]^s[e-14]^s[e-16],1);let n=r[0],i=r[1],a=r[2],c=r[3],l=r[4];for(let e=0;e<80;++e){let r=Math.floor(e/20),o=Y(n,5)+function(e,t,r,s){switch(e){case 0:return t&r^~t&s;case 1:case 3:return t^r^s;case 2:return t&r^t&s^r&s}}(r,i,a,c)+l+t[r]+s[e]>>>0;l=c,c=a,a=Y(i,30)>>>0,i=n,n=o}r[0]=r[0]+n>>>0,r[1]=r[1]+i>>>0,r[2]=r[2]+a>>>0,r[3]=r[3]+c>>>0,r[4]=r[4]+l>>>0}return Uint8Array.of(r[0]>>24,r[0]>>16,r[0]>>8,r[0],r[1]>>24,r[1]>>16,r[1]>>8,r[1],r[2]>>24,r[2]>>16,r[2]>>8,r[2],r[3]>>24,r[3]>>16,r[3]>>8,r[3],r[4]>>24,r[4]>>16,r[4]>>8,r[4])},Q=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i,B=function(e){let t;if(!("string"==typeof e&&Q.test(e)))throw TypeError("Invalid UUID");return Uint8Array.of((t=parseInt(e.slice(0,8),16))>>>24,t>>>16&255,t>>>8&255,255&t,(t=parseInt(e.slice(9,13),16))>>>8,255&t,(t=parseInt(e.slice(14,18),16))>>>8,255&t,(t=parseInt(e.slice(19,23),16))>>>8,255&t,(t=parseInt(e.slice(24,36),16))/0x10000000000&255,t/0x100000000&255,t>>>24&255,t>>>16&255,t>>>8&255,255&t)};function N(e,t,r,s){var n=t,o=s;let i="string"==typeof e?function(e){let t=new Uint8Array((e=unescape(encodeURIComponent(e))).length);for(let r=0;r<e.length;++r)t[r]=e.charCodeAt(r);return t}(e):e,a="string"==typeof n?B(n):n;if("string"==typeof n&&(n=B(n)),(null==n?void 0:n.length)!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");let c=new Uint8Array(16+i.length);if(c.set(a),c.set(i,a.length),(c=X(c))[6]=15&c[6]|80,c[8]=63&c[8]|128,r){o=o||0;for(let e=0;e<16;++e)r[o+e]=c[e];return r}return x(c)}function F(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}N.DNS="6ba7b810-9dad-11d1-80b4-00c04fd430c8",N.URL="6ba7b811-9dad-11d1-80b4-00c04fd430c8";class q{connect(e){let{url:t,reconnect:r}=e;this.wsConnect&&this.wsConnect.close(),this.connectVSCodeTimer&&(clearInterval(this.connectVSCodeTimer),this.connectVSCodeTimer=void 0);let s=()=>this.wsConnect?Promise.resolve():this.connectVSCode({url:t});return r&&(this.connectVSCodeTimer=setInterval(()=>{s()},3e4)),s()}connectVSCode(e){let{url:t}=e;return new Promise((e,r)=>{this.wsConnect&&this.wsConnect.close();try{this.wsConnect=new WebSocket(t)}catch(e){this.logger.debug("connect vscode faild",o.E(e)),r(e);return}let s=!1;this.wsConnect.addEventListener("open",()=>{this.wsConnect.send('{"action":"hello"}'),s=!0,e()}),this.wsConnect.addEventListener("message",async e=>{let t=JSON.parse(e.data);if("onchange"===t.action){let e=t.data.script;this.scriptClient.installByCode(N(t.data.uri,N.URL),e,"vscode")}}),this.wsConnect.addEventListener("error",e=>{this.wsConnect=void 0,this.logger.debug("connect vscode faild",o.E(e)),s||r(Error("connect fail"))}),this.wsConnect.addEventListener("close",()=>{this.wsConnect=void 0,this.logger.debug("vscode connection closed")})})}init(){this.group.on("connect",this.connect.bind(this))}constructor(e,t){F(this,"group",void 0),F(this,"send",void 0),F(this,"logger",void 0),F(this,"reconnect",void 0),F(this,"wsConnect",void 0),F(this,"connectVSCodeTimer",void 0),F(this,"scriptClient",void 0),this.group=e,this.send=t,this.logger=a.logger().with({service:"VSCodeConnect"}),this.reconnect=!1,this.scriptClient=new R(this.send)}}function G(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class J{logger(e){this.sendMessageToServiceWorker({action:"logger",data:e})}preparationSandbox(){this.serviceWorker.preparationOffscreen()}sendMessageToServiceWorker(e){return d(this.extensionMessage,`serviceWorker/${e.action}`,e.data)}async initManager(){this.windowServer.on("logger",this.logger.bind(this)),this.windowServer.on("preparationSandbox",this.preparationSandbox.bind(this)),this.windowServer.on("sendMessageToServiceWorker",this.sendMessageToServiceWorker.bind(this)),new D(this.windowServer.group("script"),this.extensionMessage,this.windowMessage,this.messageQueue).init(),b("serviceWorker","runtime/gmApi",this.windowServer,this.extensionMessage),b("sandbox","runtime/valueUpdate",this.windowServer,this.windowMessage),b("sandbox","runtime/emitEvent",this.windowServer,this.windowMessage),new W(this.windowServer.group("gmApi")).init(),new q(this.windowServer.group("vscodeConnect"),this.extensionMessage).init(),this.windowServer.on("createObjectURL",async e=>{let t=URL.createObjectURL(e.data);return e.persistence||setTimeout(()=>{URL.revokeObjectURL(t)},6e4),t})}constructor(e){G(this,"extensionMessage",void 0),G(this,"windowMessage",void 0),G(this,"windowServer",void 0),G(this,"messageQueue",void 0),G(this,"serviceWorker",void 0),this.extensionMessage=e,this.windowMessage=new $(window,sandbox,!0),this.windowServer=new v("offscreen",this.windowMessage),this.messageQueue=new V,this.serviceWorker=new I(this.extensionMessage)}}!function(){let e=new g;new a({writer:new l(e,"serviceWorker/logger"),labels:{env:"offscreen"}}).logger().debug("offscreen start"),new J(e).initManager()}()})()})();