(()=>{"use strict";var e={29312:function(e,t,n){t.CronJob=void 0,n(60431);var r=n(54652);Object.defineProperty(t,"CronJob",{enumerable:!0,get:function(){return r.CronJob}}),n(60431)},70864:function(e){var t=Object.prototype.hasOwnProperty,n="~";function r(){}function s(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function o(e,t,r,o,i){if("function"!=typeof r)throw TypeError("The listener must be a function");var a=new s(r,o||e,i),l=n?n+t:t;return e._events[l]?e._events[l].fn?e._events[l]=[e._events[l],a]:e._events[l].push(a):(e._events[l]=a,e._eventsCount++),e}function i(e,t){0==--e._eventsCount?e._events=new r:delete e._events[t]}function a(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(n=!1)),a.prototype.eventNames=function(){var e,r,s=[];if(0===this._eventsCount)return s;for(r in e=this._events)t.call(e,r)&&s.push(n?r.slice(1):r);return Object.getOwnPropertySymbols?s.concat(Object.getOwnPropertySymbols(e)):s},a.prototype.listeners=function(e){var t=n?n+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var s=0,o=r.length,i=Array(o);s<o;s++)i[s]=r[s].fn;return i},a.prototype.listenerCount=function(e){var t=n?n+e:e,r=this._events[t];return r?r.fn?1:r.length:0},a.prototype.emit=function(e,t,r,s,o,i){var a=n?n+e:e;if(!this._events[a])return!1;var l,c,u=this._events[a],d=arguments.length;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),d){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,r),!0;case 4:return u.fn.call(u.context,t,r,s),!0;case 5:return u.fn.call(u.context,t,r,s,o),!0;case 6:return u.fn.call(u.context,t,r,s,o,i),!0}for(c=1,l=Array(d-1);c<d;c++)l[c-1]=arguments[c];u.fn.apply(u.context,l)}else{var p,h=u.length;for(c=0;c<h;c++)switch(u[c].once&&this.removeListener(e,u[c].fn,void 0,!0),d){case 1:u[c].fn.call(u[c].context);break;case 2:u[c].fn.call(u[c].context,t);break;case 3:u[c].fn.call(u[c].context,t,r);break;case 4:u[c].fn.call(u[c].context,t,r,s);break;default:if(!l)for(p=1,l=Array(d-1);p<d;p++)l[p-1]=arguments[p];u[c].fn.apply(u[c].context,l)}}return!0},a.prototype.on=function(e,t,n){return o(this,e,t,n,!1)},a.prototype.once=function(e,t,n){return o(this,e,t,n,!0)},a.prototype.removeListener=function(e,t,r,s){var o=n?n+e:e;if(!this._events[o])return this;if(!t)return i(this,o),this;var a=this._events[o];if(a.fn)a.fn!==t||s&&!a.once||r&&a.context!==r||i(this,o);else{for(var l=0,c=[],u=a.length;l<u;l++)(a[l].fn!==t||s&&!a[l].once||r&&a[l].context!==r)&&c.push(a[l]);c.length?this._events[o]=1===c.length?c[0]:c:i(this,o)}return this},a.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&i(this,t)):(this._events=new r,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=n,a.EventEmitter=a,e.exports=a},15705:function(e,t,n){let r,s="undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),o=new Uint8Array(16),i=[];for(let e=0;e<256;++e)i.push((e+256).toString(16).slice(1));let a=function(e,t,n){var a;if(s&&!t&&!e)return s();let l=(e=e||{}).random??(null==(a=e.rng)?void 0:a.call(e))??function(){if(!r){if("undefined"==typeof crypto||!crypto.getRandomValues)throw Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");r=crypto.getRandomValues.bind(crypto)}return r(o)}();if(l.length<16)throw Error("Random bytes length must be >= 16");if(l[6]=15&l[6]|64,l[8]=63&l[8]|128,t){if((n=n||0)<0||n+16>t.length)throw RangeError(`UUID byte range ${n}:${n+15} is out of buffer bounds`);for(let e=0;e<16;++e)t[n+e]=l[e];return t}return function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return(i[e[t+0]]+i[e[t+1]]+i[e[t+2]]+i[e[t+3]]+"-"+i[e[t+4]]+i[e[t+5]]+"-"+i[e[t+6]]+i[e[t+7]]+"-"+i[e[t+8]]+i[e[t+9]]+"-"+i[e[t+10]]+i[e[t+11]]+i[e[t+12]]+i[e[t+13]]+i[e[t+14]]+i[e[t+15]]).toLowerCase()}(l)};var l=n(70864);function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class u{postMessage(e){this.target.postMessage(e,"*")}constructor(e){c(this,"target",void 0),this.target=e}}class d{sendMessage(e){let t={messageId:this.messageId,type:"connectMessage",data:e};this.target.postMessage(t)}onMessage(e){this.EE.addListener(`connectMessage:${this.messageId}`,e)}disconnect(){let e={messageId:this.messageId,type:"disconnect",data:null};this.target.postMessage(e)}onDisconnect(e){this.EE.addListener(`disconnect:${this.messageId}`,e)}constructor(e,t,n){c(this,"messageId",void 0),c(this,"EE",void 0),c(this,"target",void 0),this.messageId=e,this.EE=t,this.target=n,this.onDisconnect(()=>{this.EE.removeAllListeners("connectMessage:"+this.messageId),this.EE.removeAllListeners("disconnect:"+this.messageId)})}}let p=/YYYY|MM|DD|HH|mm|ss/g;function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}let g={none:0,trace:10,debug:100,info:1e3,warn:1e4,error:1e5};class f{log(e,t){let n;for(var r=arguments.length,s=Array(r>2?r-2:0),o=2;o<r;o++)s[o-2]=arguments[o];let i=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];let r={};return t.forEach(e=>{e.forEach(e=>{Object.keys(e).forEach(t=>{r[t]=e[t]})})}),r}(this.label,s);g[e]>=g[this.core.level]&&this.core.writer.write(e,t,i);try{n=JSON.stringify(i)}catch(e){n=i,console.error("Logger label JSON stringify error:",e)}if("none"!==this.core.consoleLevel&&g[e]>=g[this.core.consoleLevel]){"object"==typeof t&&(t=JSON.stringify(t));let r=`${function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Date,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"YYYY-MM-DD HH:mm:ss";return t.replace(p,t=>{switch(t){case"YYYY":return e.getFullYear().toString();case"MM":{let t=e.getMonth()+1;return t<10?"0"+t:t.toString()}case"DD":{let t=e.getDate();return t<10?"0"+t:t.toString()}case"HH":{let t=e.getHours();return t<10?"0"+t:t.toString()}case"mm":{let t=e.getMinutes();return t<10?"0"+t:t.toString()}case"ss":{let t=e.getSeconds();return t<10?"0"+t:t.toString()}}return t})}(new Date,"YYYY-MM-DD HH:mm:ss")} [${e}] ${t}`;switch(e){case"error":console.error(r,n);break;case"warn":console.warn(r,n);break;default:console.info(r,n)}}}with(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return new f(this.core,...this.label,...t)}trace(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];this.log("trace",e,...n)}debug(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];this.log("debug",e,...n)}info(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];this.log("info",e,...n)}warn(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];this.log("warn",e,...n)}error(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];this.log("error",e,...n)}static E(e){return"string"==typeof e?{error:e}:e instanceof Error?{error:e.message}:"object"==typeof e?e:{}}constructor(e,...t){h(this,"core",void 0),h(this,"label",void 0),this.core=e,this.label=t}}function m(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class v{static getInstance(){return v.instance}static logger(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return v.getInstance().logger(...t)}logger(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return new f(this,this.labels,...t)}constructor(e){m(this,"writer",void 0),m(this,"level","info"),m(this,"consoleLevel","warn"),m(this,"labels",void 0),this.writer=e.writer,this.level=e.level||this.level,this.labels=e.labels||{},void 0!==e.consoleLevel&&(this.consoleLevel=e.consoleLevel),v.instance||(v.instance=this)}}function b(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}m(v,"instance",void 0);async function M(e,t,n){let r=await e.sendMessage({action:t,data:n}),s=v.getInstance().logger().with({action:t,data:n,response:r});if(s.trace("sendMessage"),null==r?void 0:r.code)throw console.error(r),r.message;try{return r.data}catch(e){s.trace("Invalid response data",f.E(e));return}}class y{sendMessage(e){this.con.postMessage(e)}onMessage(e){this.con.onMessage.addListener(e)}disconnect(){this.con.disconnect()}onDisconnect(e){this.con.onDisconnect.addListener(e)}getPort(){return this.con}constructor(e){!function(e,t,n){"con"in e?Object.defineProperty(e,"con",{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(this,"con",void 0),this.con=e}}function w(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class _{getSender(){return this.sender instanceof y?this.sender.getPort().sender:this.sender}getExtMessageSender(){var e,t,n,r,s,o,i,a;if(this.sender instanceof y){let e=this.sender.getPort();return{windowId:(null==(r=e.sender)||null==(n=r.tab)?void 0:n.windowId)||-1,tabId:(null==(o=e.sender)||null==(s=o.tab)?void 0:s.id)||-1,frameId:null==(i=e.sender)?void 0:i.frameId,documentId:null==(a=e.sender)?void 0:a.documentId}}let l=this.sender;return{windowId:(null==(e=l.tab)?void 0:e.windowId)||-1,tabId:(null==(t=l.tab)?void 0:t.id)||-1,frameId:l.frameId,documentId:l.documentId}}getConnect(){return this.sender}constructor(e){w(this,"sender",void 0),this.sender=e}}class G{group(e){return new A(this,e)}on(e,t){this.apiFunctionMap.set(e,t)}connectHandle(e,t,n){let r=this.apiFunctionMap.get(e);if(r){let e=r(t,new _(n));return e&&(e instanceof Promise?e.then(e=>{e&&n.sendMessage({code:0,data:e})}).catch(e=>{n.sendMessage({code:-1,message:e.message||e.toString()})}):n.sendMessage({code:0,data:e})),!0}}messageHandle(e,t,n,r){let s=this.apiFunctionMap.get(e);if(s)try{let e=s(t,new _(r));if(e instanceof Promise)return e.then(e=>{try{n({code:0,data:e})}catch(e){this.logger.error("sendResponse error",f.E(e))}}).catch(e=>{n({code:-1,message:e.message||e.toString()})}),!0;n({code:0,data:e})}catch(e){n({code:-1,message:e.message||e.toString()})}else n({code:-1,message:"no such api "+e}),this.logger.error("no such api",{action:e})}constructor(e,t,n=!0){w(this,"enableConnect",void 0),w(this,"apiFunctionMap",void 0),w(this,"logger",void 0),this.enableConnect=n,this.apiFunctionMap=new Map,this.logger=v.getInstance().logger({service:"messageServer"}),this.enableConnect&&t.onConnect((t,n)=>{var r;if("string"==typeof t.action)return this.logger.trace("server onConnect",{msg:t}),null!=(r=t.action)&&!!r.startsWith(e)&&this.connectHandle(t.action.slice(e.length+1),t.data,n)}),t.onMessage((t,n,r)=>{var s;if("string"==typeof t.action)return this.logger.trace("server onMessage",{msg:t}),null!=(s=t.action)&&!!s.startsWith(e)&&this.messageHandle(t.action.slice(e.length+1),t.data,n,r)})}}class A{group(e){return new A(this.server,`${this.name}${e}`)}on(e,t){this.server.on(`${this.name}${e}`,t)}constructor(e,t){w(this,"server",void 0),w(this,"name",void 0),this.server=e,this.name=t,t.endsWith("/")||(this.name+="/")}}function I(e,t){return M(e,"offscreen/sendMessageToServiceWorker",{action:"script/updateRunStatus",data:t})}let E="complete";var C=n(29312);let x=new Map;function P(e,t,n,r){let s=x.get(e);s||x.set(e,s=[]),s.push({fnKey:t,api:n,param:r})}let S={};class k{static protected(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:void 0;return(t,n)=>{S[n]=e}}static API(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(t,n,r)=>{let{follow:s}=e,{alias:o}=e;s||(s=n),P(s,n,r.value,e),o&&P(o,o,r.value,e)}}}function T(e){var t;let n=null==(t=e.metadata)?void 0:t.storagename;return n?n[0]:e.uuid}function R(e){let t=e.indexOf("==UserScript=="),n=e.indexOf("==/UserScript==");return -1===t||-1===n?null:`// ${e.substring(t,n+15)}`}function L(e){let t=e.indexOf("==UserConfig=="),n=e.indexOf("==/UserConfig==");return -1===t||-1===n?null:`/* ${e.substring(t,n+15)} */`}function O(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function j(e,t,n,r){var s,o=arguments.length,i=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(o<3?s(i):o>3?s(t,n,i):s(t,n))||i);return o>3&&i&&Object.defineProperty(t,n,i),i}let U={};class D{static createGMBase(e){return new D(e,U)}sendMessage(e,t){return M(this.message,`${this.prefix}/runtime/gmApi`,{uuid:this.scriptRes.uuid,api:e,params:t,runFlag:this.runFlag})}connect(e,t){var n,r,s;return n=this.message,r=`${this.prefix}/runtime/gmApi`,s={uuid:this.scriptRes.uuid,api:e,params:t,runFlag:this.runFlag},n.connect({action:r,data:s})}valueUpdate(e){(e.uuid===this.scriptRes.uuid||e.storageName===T(this.scriptRes))&&(void 0===e.value?void 0!==this.scriptRes.value[e.key]&&delete this.scriptRes.value[e.key]:this.scriptRes.value[e.key]=e.value,this.valueChangeListener.forEach(t=>{t.name===e.key&&t.listener(e.key,e.oldValue,e.value,e.sender.runFlag!==this.runFlag,e.sender.tabId)}))}emitEvent(e,t,n){this.EE.emit(`${e}:${t}`,n)}constructor(e=null,t=null){if(O(this,"runFlag",void 0),O(this,"prefix",void 0),O(this,"message",void 0),O(this,"scriptRes",void 0),O(this,"valueChangeListener",void 0),O(this,"EE",void 0),O(this,"context",void 0),O(this,"grantSet",void 0),O(this,"eventId",void 0),t!==U)throw TypeError("Illegal invocation");Object.assign(this,e)}}j([k.protected()],D.prototype,"runFlag",void 0),j([k.protected()],D.prototype,"prefix",void 0),j([k.protected()],D.prototype,"message",void 0),j([k.protected()],D.prototype,"scriptRes",void 0),j([k.protected()],D.prototype,"valueChangeListener",void 0),j([k.protected()],D.prototype,"EE",void 0),j([k.protected()],D.prototype,"context",void 0),j([k.protected()],D.prototype,"grantSet",void 0),j([k.protected()],D.prototype,"eventId",void 0),j([k.protected()],D,"createGMBase",null),j([k.protected()],D.prototype,"sendMessage",null),j([k.protected()],D.prototype,"connect",null),j([k.protected()],D.prototype,"valueUpdate",null),j([k.protected()],D.prototype,"emitEvent",null);class V extends D{static _GM_getValue(e,t,n){let r=e.scriptRes.value[t];return void 0!==r?r:n}GM_getValue(e,t){return B(this,e,t)}"GM.getValue"(e,t){return new Promise(n=>{n(B(this,e,t))})}static _GM_setValue(e,t,n){"object"==typeof n&&(n=JSON.parse(JSON.stringify(n))),void 0===n?(delete e.scriptRes.value[t],e.sendMessage("GM_setValue",[t])):(e.scriptRes.value[t]=n,e.sendMessage("GM_setValue",[t,n]))}GM_setValue(e,t){W(this,e,t)}"GM.setValue"(e,t){return new Promise(n=>{W(this,e,t),n()})}GM_deleteValue(e){W(this,e,void 0)}"GM.deleteValue"(e){return new Promise(t=>{W(this,e,void 0),t()})}GM_listValues(){return Object.keys(this.scriptRes.value)}"GM.listValues"(){return new Promise(e=>{e(Object.keys(this.scriptRes.value))})}GM_setValues(e){if(null==e)throw Error("GM_setValues: values must not be null or undefined");if("object"!=typeof e)throw Error("GM_setValues: values must be an object");Object.keys(e).forEach(t=>{let n=e[t];W(this,t,n)})}GM_getValues(e){if(null==e)return this.scriptRes.value;let t={};if(Array.isArray(e))for(let n=0;n<e.length;n++){let r=e[n];r in this.scriptRes.value&&(t[r]=this.scriptRes.value[r])}else Object.keys(e).forEach(n=>{let r=e[n];t[n]=B(this,n,r)});return t}"GM.getValues"(e){return new Promise(t=>{t(this.GM_getValues(e))})}"GM.setValues"(e){return new Promise(t=>{this.GM_setValues(e),t()})}GM_deleteValues(e){if(!Array.isArray(e))return void console.warn("GM_deleteValues: keys must be string[]");e.forEach(e=>{W(this,e,void 0)})}"GM.deleteValues"(e){return new Promise(t=>{this.GM_deleteValues(e),t()})}GM_addValueChangeListener(e,t){return this.eventId+=1,this.valueChangeListener.set(this.eventId,{name:e,listener:t}),this.eventId}GM_removeValueChangeListener(e){this.valueChangeListener.delete(e)}GM_log(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info";for(var n=arguments.length,r=Array(n>2?n-2:0),s=2;s<n;s++)r[s-2]=arguments[s];"string"!=typeof e&&(e=JSON.stringify(e));let o=[e,t];r.length>0&&o.push(r),this.sendMessage("GM_log",o)}CAT_createBlobUrl(e){return this.sendMessage("CAT_createBlobUrl",[e])}CAT_fetchBlob(e){return this.sendMessage("CAT_fetchBlob",[e])}async CAT_fetchDocument(e){let t=await this.sendMessage("CAT_fetchDocument",[e]);return this.message.getAndDelRelatedTarget(t.relatedTarget)}static _GM_cookie(e,t,n,r){n.url||n.domain||(n.url=window.location.href),"set"!==t&&"delete"!==t||n.url||(n.url=window.location.href),e.sendMessage("GM_cookie",[t,n]).then(e=>{r&&r(e,void 0)}).catch(e=>{r&&r(void 0,e)})}"GM.cookie"(e,t){return new Promise((n,r)=>{F(this,e,t,(e,t)=>{t?r(t):n(e)})})}"GM.cookie.set"(e){return new Promise((t,n)=>{F(this,"set",e,(e,r)=>{r?n(r):t(e)})})}"GM.cookie.list"(e){return new Promise((t,n)=>{F(this,"list",e,(e,r)=>{r?n(r):t(e)})})}"GM.cookie.delete"(e){return new Promise((t,n)=>{F(this,"delete",e,(e,r)=>{r?n(r):t(e)})})}"GM_cookie.set"(e,t){F(this,"set",e,t)}"GM_cookie.list"(e,t){F(this,"list",e,t)}"GM_cookie.delete"(e,t){F(this,"delete",e,t)}GM_cookie(e,t,n){F(this,e,t,n)}GM_registerMenuCommand(e,t,n){if(this.menuMap||(this.menuMap=new Map),"object"==typeof n){let r=n;if(r.id&&this.menuMap.has(r.id))return this.EE.removeAllListeners("menuClick:"+r.id),this.EE.addListener("menuClick:"+r.id,t),this.sendMessage("GM_registerMenuCommand",[r.id,e,r]),r.id}else{n={accessKey:n};let t=0;if(this.menuMap.forEach((n,r)=>{n===e&&(t=r)}),t)return t}this.eventId+=1;let r=this.eventId;return n.id=r,this.menuMap.set(r,e),this.EE.addListener("menuClick:"+r,t),this.sendMessage("GM_registerMenuCommand",[r,e,n]),r}CAT_registerMenuInput(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return this.GM_registerMenuCommand(...t)}GM_addStyle(e){let t=this.message.syncSendMessage({action:`${this.prefix}/runtime/gmApi`,data:{uuid:this.scriptRes.uuid,api:"GM_addElement",params:[null,"style",{textContent:e}]}});if(t.code)throw Error(t.message);return this.message.getAndDelRelatedTarget(t.data)}GM_addElement(e,t,n){let r=e;r="string"!=typeof r?this.message.sendRelatedTarget(r):null;let s=this.message.syncSendMessage({action:`${this.prefix}/runtime/gmApi`,data:{uuid:this.scriptRes.uuid,api:"GM_addElement",params:[r,"string"==typeof e?e:t,"string"==typeof e?t:n]}});if(s.code)throw Error(s.message);return this.message.getAndDelRelatedTarget(s.data)}GM_unregisterMenuCommand(e){this.menuMap||(this.menuMap=new Map),this.menuMap.delete(e),this.EE.removeAllListeners("menuClick:"+e),this.sendMessage("GM_unregisterMenuCommand",[e])}CAT_unregisterMenuInput(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];this.GM_unregisterMenuCommand(...t)}CAT_userConfig(){return this.sendMessage("CAT_userConfig",[])}async CAT_fileStorage(e,t){if("config"===e)return void this.sendMessage("CAT_fileStorage",["config"]);let n={baseDir:t.baseDir||"",path:t.path||"",filename:t.filename,file:t.file};"upload"===e&&(n.data=await this.CAT_createBlobUrl(t.data)),this.sendMessage("CAT_fileStorage",[e,n]).then(async n=>{switch(n.action){case"onload":if("download"===e){let e=await this.CAT_fetchBlob(n.data);t.onload&&t.onload(e)}else t.onload&&t.onload(n.data);break;case"error":if(void 0===n.data.code){t.onerror&&t.onerror({code:-1,message:n.data.message});return}t.onerror&&t.onerror(n.data)}})}static _GM_xmlhttpRequest(e,t){let n,r=new URL(t.url,window.location.href);t.headers&&Object.keys(t.headers).forEach(e=>{"cookie"===e.toLowerCase()&&(t.cookie=t.headers[e],delete t.headers[e])});let s={method:t.method,timeout:t.timeout,url:r.href,headers:t.headers,cookie:t.cookie,context:t.context,responseType:t.responseType,overrideMimeType:t.overrideMimeType,anonymous:t.anonymous,user:t.user,password:t.password,redirect:t.redirect};return s.headers||(s.headers={}),t.nocache&&(s.headers["Cache-Control"]="no-cache"),(async()=>{var r;let o,i;if(t.data instanceof FormData){s.dataType="FormData";let n=[],r={};t.data.forEach((e,t)=>{r[t]=!0}),await Promise.all(Object.keys(r).map(r=>Promise.all(t.data.getAll(r).map(async t=>{if(t instanceof File){let s=await e.CAT_createBlobUrl(t);n.push({key:r,type:"file",val:s,filename:t.name})}else n.push({key:r,type:"text",val:t})})))),s.data=n}else t.data instanceof Blob?(s.dataType="Blob",s.data=await e.CAT_createBlobUrl(t.data)):s.data=t.data;let a=null==(r=t.responseType)?void 0:r.toLocaleLowerCase(),l=t=>("stream"===a&&(o=new ReadableStream({start(e){i=e}})),async n=>{if(n.response)if("document"===a)n.response=await e.CAT_fetchDocument(n.response),n.responseXML=n.response,n.responseType="document";else{let t=await e.CAT_fetchBlob(n.response);"arraybuffer"===a?n.response=await t.arrayBuffer():n.response=t}"stream"===a&&(n.response=o),t(n)});("arraybuffer"===a||"blob"===a||"document"===a||"stream"===a)&&(t.onload&&(t.onload=l(t.onload)),t.onreadystatechange&&(t.onreadystatechange=l(t.onreadystatechange)),t.onloadend&&(t.onloadend=l(t.onloadend)),"document"===a&&(s.responseType="blob"),"stream"===a&&t.onloadstart&&(t.onloadstart=l(t.onloadstart))),e.connect("GM_xmlhttpRequest",[s]).then(e=>{n=e,e.onMessage(e=>{var n,r,s,o,a,l,c;if(-1===e.code){v.logger().error("GM_xmlhttpRequest error",{code:e.code,message:e.message}),t.onerror&&t.onerror({readyState:4,error:e.message||"unknown"});return}switch(e.action){case"onload":null==(n=t.onload)||n.call(t,e.data);break;case"onloadend":null==(r=t.onloadend)||r.call(t,e.data);break;case"onloadstart":null==(s=t.onloadstart)||s.call(t,e.data);break;case"onprogress":null==(o=t.onprogress)||o.call(t,e.data);break;case"onreadystatechange":t.onreadystatechange&&t.onreadystatechange(e.data);break;case"ontimeout":null==(a=t.ontimeout)||a.call(t);break;case"onerror":null==(l=t.onerror)||l.call(t,e.data);break;case"onabort":null==(c=t.onabort)||c.call(t);break;case"onstream":null==i||i.enqueue(new Uint8Array(e.data));break;default:v.logger().warn("GM_xmlhttpRequest resp is error",{data:e})}})})})(),{abort:()=>{n&&n.disconnect()}}}GM_xmlhttpRequest(e){return N(this,e)}"GM.xmlHttpRequest"(e){let t,n=new Promise((n,r)=>{let s=e.onload;e.onloadend=e=>{s&&s(e),n(e)};let o=e.onerror;e.onerror=e=>{o&&o(e),r(e)},t=N(this,e)});return n.abort=()=>{t&&t.abort&&t.abort()},n}GM_download(e,t){let n,r;return n="string"==typeof e?{name:t||"",url:e}:e,this.connect("GM_download",[{method:n.method,downloadMode:n.downloadMode||"native",url:n.url,name:n.name,headers:n.headers,saveAs:n.saveAs,timeout:n.timeout,cookie:n.cookie,anonymous:n.anonymous}]).then(e=>{(r=e).onMessage(e=>{switch(e.action){case"onload":n.onload&&n.onload(e.data);break;case"onprogress":n.onprogress&&n.onprogress(e.data);break;case"ontimeout":n.ontimeout&&n.ontimeout();break;case"onerror":n.onerror&&n.onerror({error:"unknown"});break;default:v.logger().warn("GM_download resp is error",{data:e})}})}),{abort:()=>{null==r||r.disconnect()}}}async GM_notification(e,t,n,r){let s,o,i,a,l,c=this.notificationTagMap||(this.notificationTagMap=new Map);if(this.eventId+=1,"string"==typeof e)switch((s={}).text=e,arguments.length){case 4:s.onclick=r;case 3:s.image=n;case 2:s.title=t}else(s=Object.assign({},e)).ondone=s.ondone||t;s.onclick&&(o=s.onclick,delete s.onclick),s.ondone&&(i=s.ondone,delete s.ondone),s.oncreate&&(a=s.oncreate,delete s.oncreate),"string"==typeof s.tag&&(l=c.get(s.tag)),this.sendMessage("GM_notification",[s,l]).then(e=>{a&&a.apply({id:e},[e]),"string"==typeof s.tag&&c.set(s.tag,e);let t=!1;this.EE.addListener("GM_notification:"+e,n=>{switch(n.event){case"click":case"buttonClick":{let r={event:n.event,id:e,isButtonClick:"buttonClick"===n.event,buttonClickIndex:n.params.index,byUser:n.params.byUser,preventDefault:function(){t=!0},highlight:s.highlight,image:s.image,silent:s.silent,tag:s.tag,text:s.tag,timeout:s.timeout,title:s.title,url:s.url};o&&o.apply({id:e},[r]),i&&i.apply({id:e},[]),t||"string"!=typeof s.url||(window.open(s.url,"_blank"),v.logger().info("GM_notification open url："+s.url,{data:s}));break}case"close":i&&i.apply({id:e},[n.params.byUser]),"string"==typeof s.tag&&c.delete(s.tag),this.EE.removeAllListeners("GM_notification:"+this.eventId);break;default:v.logger().warn("GM_notification resp is error",{resp:n})}})})}GM_closeNotification(e){this.sendMessage("GM_closeNotification",[e])}GM_updateNotification(e,t){this.sendMessage("GM_updateNotification",[e,t])}GM_openInTab(e,t){let n,r={};1==arguments.length?r.active=!0:"boolean"==typeof t?r.active=!t:r=t,void 0===r.active&&(r.active=!0);let s={close:()=>{n&&this.GM_closeInTab(n)},closed:!1,onclose(){}};return this.sendMessage("GM_openInTab",[e,r]).then(e=>{e?(n=e,this.EE.addListener("GM_openInTab:"+e,t=>{switch(t.event){case"oncreate":n=t.tabId;break;case"onclose":s.onclose&&s.onclose(),s.closed=!0,this.EE.removeAllListeners("GM_openInTab:"+e);break;default:v.logger().warn("GM_openInTab resp is error",{resp:t})}})):(s.onclose&&s.onclose(),s.closed=!0)}),s}GM_closeInTab(e){return this.sendMessage("GM_closeInTab",[e])}GM_getTab(e){this.sendMessage("GM_getTab",[]).then(t=>{e(t??{})})}GM_saveTab(e){"object"==typeof e&&(e=JSON.parse(JSON.stringify(e))),this.sendMessage("GM_saveTab",[e])}GM_getTabs(e){this.sendMessage("GM_getTabs",[]).then(t=>{e(t)})}GM_setClipboard(e,t,n){this.sendMessage("GM_setClipboard",[e,t]).then(()=>{"function"==typeof n&&n()}).catch(()=>{"function"==typeof n&&n()})}"GM.setClipboard"(e,t){return this.sendMessage("GM_setClipboard",[e,t])}GM_getResourceText(e){if(!this.scriptRes.resource)return;let t=this.scriptRes.resource[e];if(t)return t.content}"GM.getResourceText"(e){return new Promise(t=>{t(this.GM_getResourceText(e))})}GM_getResourceURL(e,t){if(!this.scriptRes.resource)return;let n=this.scriptRes.resource[e];if(n){let e=n.base64;return(e||(e=`data:${n.contentType};base64,${btoa(encodeURIComponent(n.content).replace(/%([0-9A-F]{2})/g,(e,t)=>String.fromCharCode(parseInt(`0x${t}`,16))))}`),t)?URL.createObjectURL(function(e){let t=e.split(",")[0].split(":")[1].split(";")[0],n=atob(e.split(",")[1]),r=new Uint8Array(new ArrayBuffer(n.length));for(let e=0;e<n.length;e+=1)r[e]=n.charCodeAt(e);return new Blob([r],{type:t})}(e)):e}}"GM.getResourceUrl"(e,t){return new Promise(n=>{n(this.GM_getResourceURL(e,t))})}"window.close"(){return this.sendMessage("window.close",[])}"window.focus"(){return this.sendMessage("window.focus",[])}async AWE_engineStatus(e){let t=this.sendMessage("AWE_engineStatus",[]);if(!e)return console.log("qqq: get engine status: return promise"),t;console.log("qqq: get engine status: await"),e(await t)}AWE_getLocale(){return""}AWE_getAvailablePlayers(){return[]}AWE_openInPlayer(){}AWE_registerContextMenuCommand(){}constructor(e,t,n){super({prefix:e,message:t,scriptRes:n,valueChangeListener:new Map,EE:new l,notificationTagMap:new Map,eventId:0},U),O(this,"prefix",void 0),O(this,"message",void 0),O(this,"scriptRes",void 0),O(this,"notificationTagMap",void 0),O(this,"menuMap",void 0),this.prefix=e,this.message=t,this.scriptRes=n}}j([k.API()],V.prototype,"GM_getValue",null),j([k.API()],V.prototype,"GM.getValue",null),j([k.API()],V.prototype,"GM_setValue",null),j([k.API()],V.prototype,"GM.setValue",null),j([k.API()],V.prototype,"GM_deleteValue",null),j([k.API()],V.prototype,"GM.deleteValue",null),j([k.API()],V.prototype,"GM_listValues",null),j([k.API()],V.prototype,"GM.listValues",null),j([k.API()],V.prototype,"GM_setValues",null),j([k.API()],V.prototype,"GM_getValues",null),j([k.API({depend:["GM_getValues"]})],V.prototype,"GM.getValues",null),j([k.API({depend:["GM_setValues"]})],V.prototype,"GM.setValues",null),j([k.API()],V.prototype,"GM_deleteValues",null),j([k.API({depend:["GM_deleteValues"]})],V.prototype,"GM.deleteValues",null),j([k.API({alias:"GM.addValueChangeListener"})],V.prototype,"GM_addValueChangeListener",null),j([k.API({alias:"GM.removeValueChangeListener"})],V.prototype,"GM_removeValueChangeListener",null),j([k.API({alias:"GM.log"})],V.prototype,"GM_log",null),j([k.API()],V.prototype,"CAT_createBlobUrl",null),j([k.API()],V.prototype,"CAT_fetchBlob",null),j([k.API()],V.prototype,"CAT_fetchDocument",null),j([k.API({follow:"GM.cookie"})],V.prototype,"GM.cookie",null),j([k.API({follow:"GM.cookie"})],V.prototype,"GM.cookie.set",null),j([k.API({follow:"GM.cookie"})],V.prototype,"GM.cookie.list",null),j([k.API({follow:"GM.cookie"})],V.prototype,"GM.cookie.delete",null),j([k.API({follow:"GM_cookie"})],V.prototype,"GM_cookie.set",null),j([k.API({follow:"GM_cookie"})],V.prototype,"GM_cookie.list",null),j([k.API({follow:"GM_cookie"})],V.prototype,"GM_cookie.delete",null),j([k.API()],V.prototype,"GM_cookie",null),j([k.API({alias:"GM.registerMenuCommand"})],V.prototype,"GM_registerMenuCommand",null),j([k.API({depend:["GM_registerMenuCommand"]})],V.prototype,"CAT_registerMenuInput",null),j([k.API({alias:"GM.addStyle"})],V.prototype,"GM_addStyle",null),j([k.API({alias:"GM.addElement"})],V.prototype,"GM_addElement",null),j([k.API({alias:"GM.unregisterMenuCommand"})],V.prototype,"GM_unregisterMenuCommand",null),j([k.API({depend:["GM_unregisterMenuCommand"]})],V.prototype,"CAT_unregisterMenuInput",null),j([k.API()],V.prototype,"CAT_userConfig",null),j([k.API({depend:["CAT_fetchBlob","CAT_createBlobUrl"]})],V.prototype,"CAT_fileStorage",null),j([k.API({depend:["CAT_fetchBlob","CAT_createBlobUrl","CAT_fetchDocument"]})],V.prototype,"GM_xmlhttpRequest",null),j([k.API({depend:["CAT_fetchBlob","CAT_createBlobUrl","CAT_fetchDocument"]})],V.prototype,"GM.xmlHttpRequest",null),j([k.API({alias:"GM.download"})],V.prototype,"GM_download",null),j([k.API({depend:["GM_closeNotification","GM_updateNotification"],alias:"GM.notification"})],V.prototype,"GM_notification",null),j([k.API({alias:"GM.closeNotification"})],V.prototype,"GM_closeNotification",null),j([k.API({alias:"GM.updateNotification"})],V.prototype,"GM_updateNotification",null),j([k.API({depend:["GM_closeInTab"],alias:"GM.openInTab"})],V.prototype,"GM_openInTab",null),j([k.API({alias:"GM.closeInTab"})],V.prototype,"GM_closeInTab",null),j([k.API({alias:"GM.getTab"})],V.prototype,"GM_getTab",null),j([k.API({alias:"GM.saveTab"})],V.prototype,"GM_saveTab",null),j([k.API({alias:"GM.getTabs"})],V.prototype,"GM_getTabs",null),j([k.API({})],V.prototype,"GM_setClipboard",null),j([k.API({depend:["GM_setClipboard"]})],V.prototype,"GM.setClipboard",null),j([k.API()],V.prototype,"GM_getResourceText",null),j([k.API({depend:["GM_getResourceText"]})],V.prototype,"GM.getResourceText",null),j([k.API()],V.prototype,"GM_getResourceURL",null),j([k.API({depend:["GM_getResourceURL"]})],V.prototype,"GM.getResourceUrl",null),j([k.API()],V.prototype,"window.close",null),j([k.API()],V.prototype,"window.focus",null),j([k.API()],V.prototype,"AWE_engineStatus",null),j([k.API()],V.prototype,"AWE_getLocale",null),j([k.API()],V.prototype,"AWE_getAvailablePlayers",null),j([k.API()],V.prototype,"AWE_openInPlayer",null),j([k.API()],V.prototype,"AWE_registerContextMenuCommand",null);let{createGMBase:$}=D,{_GM_getValue:B,_GM_cookie:F,_GM_setValue:W,_GM_xmlhttpRequest:N}=V,H={this:!0,arguments:!0,[Symbol.unscopables]:!0},J=new Set(["eval","window","self","globalThis","top","parent"]),Y=Object.getOwnPropertyDescriptors(n.g),q={},K={};for(var Q=n.g,X=e=>{let[t,r]=e;if(!(!r||J.has(t))&&"string"==typeof t){if(J.add(t),r.writable){let e=r.value;if((e=>{if("function"!=typeof e||"prototype"in e)return!1;let{name:t}=e;if(!t)return!1;let n=t.charCodeAt(0);return n>=97&&n<=122})(e)){let s=e.bind(n.g);q[t]={...r,value:s}}}else if(r.configurable&&r.get&&r.set&&r.enumerable&&t.startsWith("on"))K[t]=r;else if(r.get||r.set){var s,o;q[t]={...r,get:null==r||null==(s=r.get)?void 0:s.bind(n.g),set:null==r||null==(o=r.set)?void 0:o.bind(n.g)}}}};Q&&Q!==Object;)Object.entries(Object.getOwnPropertyDescriptors(Q)).forEach(X),Q=Object.getPrototypeOf(Q);J.clear();let z=Object.create(Object.getPrototypeOf(n.g),{...Y,...q});var Z=n(26666);function ee(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class et{emitEvent(e,t,n){var r;this.logger.debug("emit event",{event:e,eventId:t,data:n}),null==(r=this.sandboxContext)||r.emitEvent(e,t,n)}valueUpdate(e){var t;null==(t=this.sandboxContext)||t.valueUpdate(e)}exec(){this.logger.debug("script start");let e=this.sandboxContext,t=e?(e=>{let t,r=Object.getOwnPropertyDescriptors(z),s=e=>function(){let r=e.call(n.g);return r===n.g?t:r},o=e=>{let r=e.slice(2),s={fn:null,handleEvent(o){let i=t[e];i&&i===this.fn?i.call(t,o):(n.g.removeEventListener(r,s),this.fn=null)}};return{get:()=>s.fn,set(e){let{fn:t}=s;if(e!==t){let o;(o=e)!==Object(o)&&(e=null),typeof t!=typeof e&&("function"==typeof t?n.g.removeEventListener(r,s):"function"==typeof e&&n.g.addEventListener(r,s)),s.fn=e}}}};for(let e of Object.keys(K)){let t=o(e);r[e]={...r[e],...t}}for(let e of["window","self","globalThis","top","parent"]){let o=r[e];(null==o?void 0:o.value)===n.g?(o.get=function(){return t},o.set=void 0,delete o.writable,delete o.value):(null==o?void 0:o.get)&&(o.get=s(o.get),o.set=void 0)}for(let e of(r.$={enumerable:!1,configurable:!0,get(){return delete this.$,t}},(t=Object.create(Object.getPrototypeOf(z),r))[Symbol.unscopables]={...t[Symbol.unscopables]||{},...H},["define","module","exports"]))t[e]=void 0;for(let n of Object.keys(e))n in S||"window"===n||(t[n]=e[n]);let i=e.window;return(null==i?void 0:i.close)&&(t.close=i.close),(null==i?void 0:i.focus)&&(t.focus=i.focus),(null==i?void 0:i.onurlchange)===null&&(t.onurlchange=null),t})(e):n.g;return this.scriptFunc.call(t,this.named,this.scriptRes.name)}stop(){return this.logger.debug("script stop"),!0}constructor(e,t,n,r,s,o){ee(this,"scriptRes",void 0),ee(this,"scriptFunc",void 0),ee(this,"logger",void 0),ee(this,"sandboxContext",void 0),ee(this,"named",void 0),this.scriptRes=e,this.logger=v.getInstance().logger({component:"exec",uuid:this.scriptRes.uuid,name:this.scriptRes.name});let i=function(e,t){var n,r,s,o,i;let a={description:(null==(n=t.metadata.description)?void 0:n[0])||null,matches:t.metadata.match||[],includes:t.metadata.include||[],"run-at":(null==(r=t.metadata["run-at"])?void 0:r[0])||"document-idle","run-in":t.metadata["run-in"]||[],icon:(null==(s=t.metadata.icon)?void 0:s[0])||null,icon64:(null==(o=t.metadata.icon64)?void 0:o[0])||null,header:t.metadataStr,grant:t.metadata.grant||[],connects:t.metadata.connect||[]};return{downloadMode:"native",isIncognito:e.isIncognito,sandboxMode:e.sandboxMode,scriptWillUpdate:!0,scriptHandler:"AceScript",userAgentData:e.userAgentData,scriptUpdateURL:t.downloadUrl||null,scriptMetaStr:t.metadataStr,userConfig:function(e){let t=/\/\*\s*==UserConfig==([\s\S]+?)\s*==\/UserConfig==\s*\*\//m.exec(e);if(!t)return;let n=t[1].trim().split(/[-]{3,}/),r={};for(let e of n){let t=(0,Z.Qc)(e);if(t&&"object"==typeof t)for(let[e,n]of Object.entries(t)){if(!n||"object"!=typeof n)throw Error(`UserConfig group "${e}" is not a valid object.`);r[e]=n,Object.keys(r[e]||{}).forEach((t,n)=>{r[e][t]&&"object"==typeof r[e][t]&&(r[e][t].index=r[e][t].index||n)})}}return r}(t.userConfigStr),userConfigStr:t.userConfigStr,version:"1.2.6",script:{name:t.name,namespace:t.namespace,version:null==(i=t.metadata.version)?void 0:i[0],author:t.author,lastModified:t.updatetime,downloadURL:t.downloadUrl||null,updateURL:t.checkUpdateUrl||null,...a}}}(s,this.scriptRes);"string"==typeof r?this.scriptFunc=Function(r):this.scriptFunc=r;let c=new Set(e.metadata.grant||[]);c.has("none")?this.named={GM:{info:i},GM_info:i}:(this.sandboxContext=((e,t,n,r,s)=>{let o=$({prefix:n,message:r,scriptRes:e,valueChangeListener:new Map,EE:new l,runFlag:a(),eventId:1e4,GM:{info:t},GM_info:t,window:{},grantSet:new Set}),i={},c=e=>{let t=o.grantSet,n=x.get(e);if(!n)return!1;if(t.has(e))return!0;for(let{fnKey:r,api:s,param:a}of(t.add(e),n)){i[r]=s.bind(o);let e=null==a?void 0:a.depend;if(e)for(let t of e)c(t)}return!0};for(let e of s)c(e);for(let e of Object.keys(i)){let t=e.split("."),n=t.length,r=o,s="";for(let e=0;e<n;e++){let n=t[e];s+=`${e?".":""}${n}`,r=r[n]||(r[n]=i[s]||{})}}return o.unsafeWindow=window,o})(e,i,t,n,c),o&&Object.assign(this.sandboxContext,o))}}function en(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class er{constructor(e,t){en(this,"msg",void 0),en(this,"time",void 0),this.msg=e,"number"==typeof t?this.time=new Date(Date.now()+1e3*t):this.time=t}}class es extends et{stop(){return this.setTimeout.forEach((e,t)=>{n.g.clearTimeout(t)}),this.setTimeout.clear(),this.setInterval.forEach((e,t)=>{n.g.clearInterval(t)}),this.setInterval.clear(),super.stop()}constructor(e,t){let r={},s=new Map,o=new Map;r.setTimeout=function(e,t){for(var r=arguments.length,o=Array(r>2?r-2:0),i=2;i<r;i++)o[i-2]=arguments[i];let a=n.g.setTimeout(function(){s.delete(a),"function"==typeof e&&e()},t,...o);return s.set(a,!0),a},r.clearTimeout=function(e){s.delete(e),n.g.clearTimeout(e)},r.setInterval=function(e,t){for(var r=arguments.length,s=Array(r>2?r-2:0),i=2;i<r;i++)s[i-2]=arguments[i];let a=n.g.setInterval(function(){"function"==typeof e&&e()},t,...s);return o.set(a,!0),a},r.clearInterval=function(e){o.delete(e),n.g.clearInterval(e)},r.CATRetryError=er,super(e,"offscreen",t,e.code,{sandboxMode:"raw",userAgentData:{brands:[],mobile:!1,platform:""},isIncognito:!1},r),en(this,"setTimeout",void 0),en(this,"setInterval",void 0),this.setTimeout=s,this.setInterval=o}}function eo(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class ei{joinRetryList(e){e.nextruntime&&(this.retryList.push({script:e,retryTime:e.nextruntime}),this.retryList.sort((e,t)=>e.retryTime-t.retryTime))}removeRetryList(e){for(let t=0;t<this.retryList.length;t+=1)this.retryList[t].script.uuid===e&&(this.retryList.splice(t,1),t-=1)}async enableScript(e){return(this.execScripts.has(e.uuid)&&await this.disableScript(e.uuid),e.metadataStr=R(e.code)||"",e.userConfigStr=L(e.code)||"",3===e.type)?this.execScript(e):(await this.stopCronJob(e.uuid),this.crontabScript(e))}disableScript(e){return this.stopCronJob(e),this.removeRetryList(e),I(this.windowMessage,{uuid:e,runStatus:E}),this.stopScript(e)}async execScript(e,t){let n=this.logger.with({uuid:e.uuid,name:e.name});this.execScripts.has(e.uuid)&&await this.stopScript(e.uuid);let r=new es(e,this.windowMessage);this.execScripts.set(e.uuid,r),I(this.windowMessage,{uuid:e.uuid,runStatus:"running"}),e.lastruntime=Date.now();let s=r.exec();return s instanceof Promise?s.then(t=>{I(this.windowMessage,{uuid:e.uuid,runStatus:E}),n.info("exec script complete",{value:t})}).catch(r=>{let s,o=0;throw r instanceof er?(s={error:r.msg},t||(e.nextruntime=o=r.time.getTime(),this.joinRetryList(e))):s=f.E(r),n.error("exec script error",s),I(this.windowMessage,{uuid:e.uuid,runStatus:"error",error:s,nextruntime:o}),r}):n.warn("backscript return not promise"),s}crontabScript(e){if(!e.metadata.crontab)throw Error(e.name+" - 错误的crontab表达式");this.joinRetryList(e),this.crontabSripts.push(e);let t=!1,n=[];return e.metadata.crontab.forEach(r=>{let s=0,o=r;if(o.includes("once")){let e=o.split(" ");e.forEach((e,t)=>{"once"===e&&(s=t)}),5===e.length&&(s+=1),o=o.replace(/once/g,"*")}try{let t=new C.CronJob(o,this.crontabExec(e,s));t.start(),n.push(t)}catch(n){t=!0,this.logger.error("create cronjob failed",{uuid:e.uuid,crontab:r},f.E(n))}}),n.length!==e.metadata.crontab.length?n.forEach(e=>{e.stop()}):this.cronJob.set(e.uuid,n),!t}crontabExec(e,t){return t?()=>{if(!e.lastruntime)return void this.execScript(e);let n=new Date,r=new Date(e.lastruntime),s=!1;switch(t){case 1:s=r.getMinutes()!==n.getMinutes();break;case 2:s=r.getHours()!==n.getHours();break;case 3:s=r.getDay()!==n.getDay();break;case 4:s=r.getMonth()!==n.getMonth();break;case 5:s=this.getWeek(r)!==this.getWeek(n)}s&&this.execScript(e)}:()=>{this.execScript(e)}}getWeek(e){let t=new Date(e),n=new Date(e);n.setMonth(0),n.setDate(1);let r=Math.ceil(Math.ceil((t.getTime()-n.getTime())/864e5)/7);return 0===r?1:r}stopCronJob(e){let t=this.cronJob.get(e);t&&(t.forEach(e=>{e.stop()}),this.cronJob.delete(e)),this.crontabSripts=this.crontabSripts.filter(t=>t.uuid!==e)}async stopScript(e){let t=this.execScripts.get(e);return t?(t.stop(),this.execScripts.delete(e),I(this.windowMessage,{uuid:e,runStatus:E}),!0):(I(this.windowMessage,{uuid:e,runStatus:E}),!1)}async runScript(e){return this.execScripts.get(e.uuid)&&await this.stopScript(e.uuid),e.metadataStr=R(e.code)||"",e.userConfigStr=L(e.code)||"",this.execScript(e,!0)}valueUpdate(e){this.execScripts.forEach(t=>{(t.scriptRes.uuid===e.uuid||T(t.scriptRes)===e.storageName)&&t.valueUpdate(e)}),this.crontabSripts.forEach(t=>{(t.uuid===e.uuid||T(t)===e.storageName)&&(t.value[e.key]=e.value)})}emitEvent(e){let t=this.execScripts.get(e.uuid);t&&t.emitEvent(e.event,e.eventId,e.data)}init(){this.api.on("enableScript",this.enableScript.bind(this)),this.api.on("disableScript",this.disableScript.bind(this)),this.api.on("runScript",this.runScript.bind(this)),this.api.on("stopScript",this.stopScript.bind(this)),this.api.on("runtime/valueUpdate",this.valueUpdate.bind(this)),this.api.on("runtime/emitEvent",this.emitEvent.bind(this))}constructor(e,t){eo(this,"windowMessage",void 0),eo(this,"api",void 0),eo(this,"cronJob",void 0),eo(this,"execScripts",void 0),eo(this,"logger",void 0),eo(this,"retryList",void 0),eo(this,"crontabSripts",void 0),this.windowMessage=e,this.api=t,this.cronJob=new Map,this.execScripts=new Map,this.retryList=[],this.crontabSripts=[],this.logger=v.getInstance().logger({component:"sandbox"}),setInterval(()=>{if(!this.retryList.length)return;let e=Date.now(),t=[];for(let n=0;n<this.retryList.length;n+=1){let r=this.retryList[n];r.retryTime<e&&(this.retryList.splice(n,1),n-=1,t.push(r.script))}t.forEach(e=>{e.nextruntime=0,this.execScript(e)})},5e3)}}function ea(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}let el=new class e{messageHandle(e,t){"sendMessage"===e.type?this.EE.emit("message",e.data,n=>{if(!e.messageId)return;let r={messageId:e.messageId,type:"respMessage",data:n};t.postMessage(r)}):"respMessage"===e.type?this.EE.emit(`response:${e.messageId}`,e):"connect"===e.type?this.EE.emit("connect",e.data,new d(e.messageId,this.EE,t)):"disconnect"===e.type?this.EE.emit(`disconnect:${e.messageId}`):"connectMessage"===e.type&&this.EE.emit(`connectMessage:${e.messageId}`,e.data)}onConnect(e){this.EE.addListener("connect",e)}connect(e){return new Promise(t=>{let n={messageId:a(),type:"connect",data:e};this.target.postMessage(n,"*"),t(new d(n.messageId,this.EE,this.target))})}onMessage(e){this.EE.addListener("message",e)}sendMessage(e){return new Promise(t=>{let n={messageId:a(),type:"sendMessage",data:e},r=`response:${n.messageId}`,s=e=>{null!==s&&(this.EE.removeListener(r,s),t(e.data),s=null,t=null)};this.EE.addListener(r,s),this.target.postMessage(n,"*")})}constructor(e,t,n){c(this,"source",void 0),c(this,"target",void 0),c(this,"serviceWorker",void 0),c(this,"EE",void 0),this.source=e,this.target=t,this.serviceWorker=n,this.EE=new l,this.source.addEventListener("message",e=>{(e.source===this.target||e.source===this.source)&&this.messageHandle(e.data,new u(this.target))}),this.serviceWorker&&navigator.serviceWorker.addEventListener("message",e=>{e.source&&this.messageHandle(e.data,e.source)})}}(window,parent);new v({writer:new class e{write(e,t,n){this.send.sendMessage({action:this.action,data:{id:0,level:e,message:t,label:n,createtime:Date.now()}})}constructor(e,t="logger"){b(this,"action",void 0),b(this,"send",void 0),this.action=t,this.send=e}}(el,"offscreen/logger"),labels:{env:"sandbox"}}).logger().debug("offscreen start"),new class e{initManager(){new ei(this.windowMessage,this.api).init(),M(this.windowMessage,"offscreen/preparationSandbox")}constructor(e){ea(this,"windowMessage",void 0),ea(this,"api",void 0),this.windowMessage=e,this.api=new G("sandbox",this.windowMessage)}}(el).initManager()},74244:function(){}},t={};function n(r){var s=t[r];if(void 0!==s)return s.exports;var o=t[r]={exports:{}};return e[r].call(o.exports,o,o.exports,n),o.exports}n.m=e,n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.g=(()=>{if("object"==typeof globalThis)return globalThis;try{return this||Function("return this")()}catch(e){if("object"==typeof window)return window}})(),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e=[];n.O=(t,r,s,o)=>{if(r){o=o||0;for(var i=e.length;i>0&&e[i-1][2]>o;i--)e[i]=e[i-1];e[i]=[r,s,o];return}for(var a=1/0,i=0;i<e.length;i++){for(var[r,s,o]=e[i],l=!0,c=0;c<r.length;c++)(!1&o||a>=o)&&Object.keys(n.O).every(e=>n.O[e](r[c]))?r.splice(c--,1):(l=!1,o<a&&(a=o));if(l){e.splice(i--,1);var u=s();void 0!==u&&(t=u)}}return t}})(),n.rv=()=>"1.4.11",(()=>{var e={6723:0};n.O.j=t=>0===e[t];var t=(t,r)=>{var s,o,[i,a,l]=r,c=0;if(i.some(t=>0!==e[t])){for(s in a)n.o(a,s)&&(n.m[s]=a[s]);if(l)var u=l(n)}for(t&&t(r);c<i.length;c++)o=i[c],n.o(e,o)&&e[o]&&e[o][0](),e[o]=0;return n.O(u)},r=self.webpackChunkacescript=self.webpackChunkacescript||[];r.forEach(t.bind(null,0)),r.push=t.bind(null,r.push.bind(r))})(),n.ruid="bundler=rspack@1.4.11";var r=n.O(void 0,["4998"],function(){return n(15705)});r=n.O(r)})();